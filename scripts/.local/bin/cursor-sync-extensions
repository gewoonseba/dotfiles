#!/usr/bin/env bash

# Standard symlink resolution
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR/../../.." && pwd)"
EXTENSIONS_FILE="$DOTFILES_DIR/cursor-extensions/extensions.txt"

if ! command -v cursor &> /dev/null; then
    echo "Error: cursor command not found. Is Cursor installed?"
    exit 1
fi

if [ ! -f "$EXTENSIONS_FILE" ]; then
    echo "Error: extensions.txt not found at $EXTENSIONS_FILE"
    exit 1
fi

echo "Syncing Cursor extensions..."
echo ""

# Get currently installed extensions (as string, not array)
INSTALLED=$(cursor --list-extensions)

# Get extensions from file (skip empty lines and comments)
DESIRED=$(grep -v '^#' "$EXTENSIONS_FILE" | grep -v '^[[:space:]]*$')

# Install missing extensions
echo "=== Installing missing extensions ==="
installed_count=0
while IFS= read -r ext; do
    [ -z "$ext" ] && continue
    if ! echo "$INSTALLED" | grep -qx "$ext"; then
        echo "Installing: $ext"
        cursor --install-extension "$ext"
        installed_count=$((installed_count + 1))
    fi
done <<< "$DESIRED"

if [ $installed_count -eq 0 ]; then
    echo "No extensions to install."
fi
echo ""

# Uninstall extensions not in the list
echo "=== Removing extensions not in list ==="
removed_count=0
while IFS= read -r ext; do
    [ -z "$ext" ] && continue
    if ! echo "$DESIRED" | grep -qx "$ext"; then
        echo "Uninstalling: $ext"
        cursor --uninstall-extension "$ext"
        removed_count=$((removed_count + 1))
    fi
done <<< "$INSTALLED"

if [ $removed_count -eq 0 ]; then
    echo "No extensions to remove."
fi
echo ""

echo "=== Sync Complete ==="
echo "Installed: $installed_count"
echo "Removed: $removed_count"